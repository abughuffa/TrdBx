
@using CleanArchitecture.Blazor.Application.Features.VehicleTypes.Commands.AddEdit
@using CleanArchitecture.Blazor.Application.Features.VehicleTypes.Commands.Delete
@using CleanArchitecture.Blazor.Application.Features.VehicleTypes.DTOs
@using CleanArchitecture.Blazor.Application.Features.VehicleTypes.Mappers
@using CleanArchitecture.Blazor.Application.Features.VehicleTypes.Queries.GetAll
@using CleanArchitecture.Blazor.Server.UI.Pages.VehicleTypes.Components

@inherits MudComponentBase
@inject IStringLocalizer<VehicleTypes> L
@attribute [Authorize(Policy = Permissions.VehicleTypes.View)]


<MudGrid>
  @*   Label="@L["VehicleType"]" *@
    <MudItem md="8">
        <MudSelect T="int"
                   
                   Required="true"
                   RequiredError="@L["VehicleType is required!"]"
                   Value="VehicleTypeId"
                   ValueChanged="OnVehicleTypeChanged">
            <MudSelectItem Value=0>Select a VehicleType</MudSelectItem>

            @foreach (var doc1type in vehicleTypes)
            {
                <MudSelectItem Value="doc1type.Id">@doc1type.Name</MudSelectItem>
            }
        </MudSelect>
    </MudItem>
    <MudItem md="1">
        <MudIconButton Variant="Variant.Outlined"
                       OnClick="@(()=>OnView(SelectedVehicleType))"
                       Disabled="isDisabled"
                       Icon="@Icons.Material.Filled.Preview"
                       Size="Size.Small"
                       Color="Color.Primary">
        </MudIconButton>
    </MudItem>

    <MudItem md="1">
        <MudIconButton Variant="Variant.Outlined"
                       OnClick="@(()=>OnEdit(SelectedVehicleType))"
                       Disabled="isDisabled"
                       Icon="@Icons.Material.Filled.Edit"
                       Size="Size.Small"
                       Color="Color.Primary">
        </MudIconButton>
    </MudItem>

    <MudItem md="1">
        <MudIconButton Variant="Variant.Outlined"
                       OnClick="@(()=>OnCreate())"
                       Icon="@Icons.Material.Filled.Add"
                       Size="Size.Small"
                       Color="Color.Primary">
        </MudIconButton>
    </MudItem>

    <MudItem md="1">
        <MudIconButton Variant="Variant.Outlined"
                       OnClick="@(()=>OnDelete(SelectedVehicleType))"
                       Disabled="isDisabled"
                       Icon="@Icons.Material.Filled.Delete"
                       Size="Size.Small"
                       Color="Color.Primary">
        </MudIconButton>
    </MudItem>



</MudGrid>

@code {

    [Parameter]
    public EventCallback<int> VehicleTypeIdChanged { get; set; }

    private int _vehicleTypeId;
    [Parameter]
    public int VehicleTypeId
    {
        get => _vehicleTypeId;
        set
        {
            if (_vehicleTypeId != value)
            {
                _vehicleTypeId = value;
                VehicleTypeIdChanged.InvokeAsync(value);
            }
        }
    }


    private IEnumerable<VehicleTypeDto> vehicleTypes = default!;
    private GetAllVehicleTypesQuery GetAllVehicleTypesQuery { get; set; } = new();

    public VehicleTypeDto SelectedVehicleType { get; set; } = null!;
    private void OnVehicleTypeChanged(int id)
    {
        VehicleTypeId = id;
        SelectedVehicleType = vehicleTypes.FirstOrDefault(m => m.Id == id);
    }

    bool isDisabled => (SelectedVehicleType is null);

    protected override async Task OnInitializedAsync()
    {
        vehicleTypes = await LoadVehicleTypes();
    }

    private async Task<IEnumerable<VehicleTypeDto>> LoadVehicleTypes()
    {
        var result = await Mediator.Send(GetAllVehicleTypesQuery).ConfigureAwait(false);
        return result;
    }

    private async Task OnView(VehicleTypeDto dto)
    {
        await ShowViewFormDialog("VehicleType", dto);
        SelectedVehicleType = dto;
    }

    private async Task OnCreate()
    {

        // var command = Mapper.Map<AddEditVehicleTypeCommand>(new VehicleTypeDto());
        var VehicleTypeDto = (new VehicleTypeDto());
        var command = VehicleTypeMapper.CloneFromDto(VehicleTypeDto);
        // var command = new AddEditVehicleTypeCommand();
        await ShowAddEditFormDialog(string.Format(ConstantString.CreateAnItem, L["VehicleType"]), command);
    }

    private async Task OnEdit(VehicleTypeDto dto)
    {

        // var command = Mapper.Map<AddEditVehicleTypeCommand>(dto);
        // var VehicleTypeDto = (new VehicleTypeDto());
        var command = VehicleTypeMapper.CloneFromDto(dto);
        // var command = new AddEditVehicleTypeCommand() { Id = dto.Id, Name = dto.Name};
        await ShowAddEditFormDialog(string.Format(ConstantString.EditTheItem, L["VehicleType"]), command);
    }

    private Task OnDelete(VehicleTypeDto dto)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.Name);
        var command = new DeleteVehicleTypeCommand(new int[] { dto.Id });
        return DialogServiceHelper.ShowDeleteConfirmationDialogAsync(
            command,
            ConstantString.DeleteConfirmationTitle,
            contentText,
            async () =>
            {
                vehicleTypes = await LoadVehicleTypes();

                SelectedVehicleType = null;
            });

    }


    private async Task ShowAddEditFormDialog(string title, AddEditVehicleTypeCommand command)
    {
        var parameters = new DialogParameters<VehicleTypeAddEditDialog>
            {
                { x=>x.model,command },
            };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<VehicleTypeAddEditDialog>(title, parameters, options);
        var state = await dialog.Result;

        if (state != null && !state.Canceled)
        {
            vehicleTypes = await LoadVehicleTypes();
        }
    }

    private async Task ShowViewFormDialog(string title, VehicleTypeDto dto)
    {
        var parameters = new DialogParameters<VehicleTypeViewDialog>
            {
                { x=>x.model,dto},
            };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<VehicleTypeViewDialog>(title, parameters, options);
        var state = await dialog.Result;

        if (state != null && !state.Canceled)
        {
            vehicleTypes = await LoadVehicleTypes();
            SelectedVehicleType = dto;
        }
    }
}

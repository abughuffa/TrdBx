@page "/pages/TrdBx/TrackingUnits/{trackingunitid:int?}/ServiceLogs"

@using CleanArchitecture.Blazor.Application.Features.ServiceLogs.Caching
@using CleanArchitecture.Blazor.Application.Features.ServiceLogs.DTOs
@using CleanArchitecture.Blazor.Application.Features.ServiceLogs.Queries.Pagination
@using CleanArchitecture.Blazor.Application.Features.ServiceLogs.Mappers
@using CleanArchitecture.Blazor.Server.UI.Pages.TrdBx.ServiceLogs.Components


@inject IStringLocalizer<ServiceLogs> L
@inject NavigationManager Navigation
@attribute [Authorize(Policy = Infrastructure.PermissionSet.Permissions.ServiceLogs.View)]


<MudContainer Class="mt-3">
    <AdvancedSearchServiceLogs TRequest="Query" OnFilterCriteriaChanged="FilterCriteriaChanged"></AdvancedSearchServiceLogs>
    <MudCard>
@*         <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">@Title</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent> *@
            @* RowClick="@(s=>OnView(s.Item))" *@

        <MudCardContent>
            <MudDataGrid ServerData="@(ServerReload)"
                         FixedHeader="true"
                         FixedFooter="false"
                         Virtualize="false"
                         @bind-RowsPerPage="_defaultPageSize"
                         Loading="@_loading"
                         MultiSelection="true"
                         T="ServiceLogDto"
                         SelectOnRowClick="false"
                         @bind-SelectedItems="_selectedItems"
                         Hover="true" @ref="_table">

                <ToolBarContent>
                    <MudStack Row Spacing="0" Class="flex-grow-1" Justify="Justify.SpaceBetween">

                        <MudStack Row AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Window" Size="Size.Large" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">@Title</MudText>
                            </MudStack>
                        </MudStack>

                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudToolBar Dense WrapContent="true" Class="py-1 px-0">

                                <MudButton Disabled="@_loading"
                                           OnClick="@(() => OnRefresh())"
                                           StartIcon="@Icons.Material.Outlined.Refresh">
                                    @ConstantString.Refresh
                                </MudButton>





                            </MudToolBar>


                        </MudStack>

                    </MudStack>


                </ToolBarContent>

            

                <Columns>


                    <TemplateColumn Title=@ConstantString.Actions HeaderStyle="width:80px" Sortable="false">
                        <CellTemplate>

                            <MudStack Spacing="2" Row="true" Justify="Justify.FlexStart">
                                <MudMenu Icon="@Icons.Material.Filled.AvTimer"
                                         Variant="Variant.Filled"
                                         Size="Size.Small"
                                         Dense="true"
                                         EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                                         IconColor="Color.Info"
                                         AnchorOrigin="Origin.CenterLeft">

                                    <MudMenuItem OnClick="@(()=>OnViewWialonTasks(context.Item))">View Wialon tasks</MudMenuItem>

                                    <MudMenuItem OnClick="@(()=>OnViewSubscriptions(context.Item))">View Subscription periods</MudMenuItem>

                                </MudMenu>
                            </MudStack>

                        </CellTemplate>
                    </TemplateColumn>





                    <PropertyColumn Property="x => x.ServiceNo" Title="@L[_currentDto.GetMemberDescription(x=>x.ServiceNo)]" />
                    <PropertyColumn Property="x => x.CreatedByUser.DisplayName" Title="@L[_currentDto.GetMemberDescription(x => x.CreatedByUser)]" />
                    <PropertyColumn Property="x => x.Customer" Title="@L[_currentDto.GetMemberDescription(x => x.Customer)]" />
                   @*  <PropertyColumn Property="x => x.InstallerId" Title="@L[_currentDto.GetMemberDescription(x => x.InstallerId)]" /> *@
                    @* <PropertyColumn Property="x => x.Installer" Title="@L[_currentDto.GetMemberDescription(x => x.Installer)]" /> *@
                       <PropertyColumn Property="x => x.Desc" Title="@L[_currentDto.GetMemberDescription(x=>x.Desc)]" />
                    <PropertyColumn Property="x => x.SerDate" Title="@L[_currentDto.GetMemberDescription(x=>x.SerDate)]" />
                    <PropertyColumn Property="x => x.IsDeserved" Title="@L[_currentDto.GetMemberDescription(x=>x.IsDeserved)]" />
                    <PropertyColumn Property="x => x.IsBilled" Title="@L[_currentDto.GetMemberDescription(x=>x.IsBilled)]" />
                    <PropertyColumn Property="x => x.Amount" Title="@L[_currentDto.GetMemberDescription(x=>x.Amount)]" />
                </Columns>
                <NoRecordsContent>
                    <MudText>@ConstantString.NoRecords</MudText>
                </NoRecordsContent>
                <LoadingContent>
                    <MudText>@ConstantString.Loading</MudText>
                </LoadingContent>
                <PagerContent>
                    <MudDataGridPager PageSizeOptions="@(new int[] { 10, 15, 30, 50, 100 })" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
        <MudCardActions >
            <MudButton Color="Color.Primary" DropShadow="false" OnClick="GoBack">@ConstantString.GoBack</MudButton>
        </MudCardActions>
    </MudCard>
</MudContainer>


@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }
    [Parameter] public int TrackingUnitId { get; set; } = 0;
    public string? Title { get; private set; }
    private HashSet<ServiceLogDto> _selectedItems = new();
    private MudDataGrid<ServiceLogDto> _table = default!;
    private ServiceLogDto _currentDto = new();
    // private ServiceLogsAccessRights _accessRights = new();
    private int _defaultPageSize = 10;
    private bool _loading;
    private bool filterDisabled;

    private ServiceLogsWithPaginationQuery Query { get; set; } = new();

    [Parameter]
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    [Inject]
    private IBlazorDownloadFileService BlazorDownloadFileService { get; set; } = null!;
    private bool _canSearch;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;
    private bool _canImport;
    private bool _canExport;

    protected override async Task OnInitializedAsync()
    {
        Title = L[_currentDto.GetClassDescription()];
        var state = await AuthState;
        _canCreate = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.ServiceLogs.Create)).Succeeded;
        _canSearch = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.ServiceLogs.Search)).Succeeded;
        _canEdit = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.ServiceLogs.Edit)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.ServiceLogs.Delete)).Succeeded;
        _canImport = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.ServiceLogs.Import)).Succeeded;
        _canExport = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.ServiceLogs.Export)).Succeeded;
    }
    // protected override async Task OnInitializedAsync()
    // {
    //     Title = L[_currentDto.GetClassDescription()];
    //     _accessRights = await PermissionService.GetAccessRightsAsync<ServiceLogsAccessRights>();

    //     filterDisabled = TrackingUnitId == 0 ? false : true;
    // }


    private void FilterCriteriaChanged(string s)
    {
        InvokeAsync(_table.ReloadServerData);
    }



    private async Task<GridData<ServiceLogDto>> ServerReload(GridState<ServiceLogDto> state)
    {

        try
        {
            _loading = true;
            Query.TrackingUnitId = TrackingUnitId;
            Query.OrderBy = state.SortDefinitions.FirstOrDefault()?.SortBy ?? "Id";
            Query.SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending ?? true
                                              ? SortDirection.Descending.ToString()
                                              : SortDirection.Ascending.ToString();
            Query.PageNumber = state.Page + 1;
            Query.PageSize = state.PageSize;
            var result = await Mediator.Send(Query).ConfigureAwait(false);
            return new GridData<ServiceLogDto> { TotalItems = result.TotalItems, Items = result.Items };
        }
        finally
        {
            _loading = false;
        }

    }

    private async Task OnRefresh()
    {
        ServiceLogCacheKey.Refresh();
        _selectedItems = new HashSet<ServiceLogDto>();
        Query.TrackingUnitId = TrackingUnitId;
        await _table.ReloadServerData();
    }

    private Task OnViewWialonTasks(ServiceLogDto dto)
    {
        Navigation.NavigateTo($"/pages/TrdBx/WialonTasks/0/{dto.Id}?returnUrl={Uri.EscapeDataString(Navigation.Uri)}");
        return Task.CompletedTask;
    }

    private Task OnViewSubscriptions(ServiceLogDto dto)
    {
        Navigation.NavigateTo($"/pages/TrdBx/Subscriptions/0/{dto.Id}?returnUrl={Uri.EscapeDataString(Navigation.Uri)}");
        return Task.CompletedTask;
    }

    private Task GoBack()
    {
        var target = !string.IsNullOrWhiteSpace(ReturnUrl)
            ? ReturnUrl
            : Navigation.ToBaseRelativePath(Navigation.Uri);

        Navigation.NavigateTo(target);
        return Task.CompletedTask;

    }

}

@page "/pages/TrdBx/BackupRestore"

@using CleanArchitecture.Blazor.Application.Features.DbAdmininstraion.Commands.Create
@using CleanArchitecture.Blazor.Application.Features.DbAdmininstraion.Commands.Delete
@using CleanArchitecture.Blazor.Application.Features.DbAdmininstraion.Commands.Restore
@using CleanArchitecture.Blazor.Application.Features.DbAdmininstraion.DTOs
@using CleanArchitecture.Blazor.Application.Features.DbAdmininstraion.Queries


@inject IStringLocalizer<BackupRestore> L
@attribute [Authorize(Policy = Infrastructure.PermissionSet.Permissions.BackupRestore.View)]

<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h6" Class="mb-4">Database Backup & Restore</MudText>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="backupName" Label="Backup Name" Variant="Variant.Outlined" FullWidth />
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-center">
                <MudLoadingButton Loading="_uploading" Variant="Variant.Filled" Color="Color.Primary" OnClick="OnCreateBackup"
                                  Disabled="@((backupName is null) && !_canCreate)" Class="ml-2" EndIcon="@Icons.Material.Filled.Backup">
                    Create Backup
                </MudLoadingButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="LoadBackups" 
                           Class="ml-2" EndIcon="@Icons.Material.Filled.Refresh">
                    Refresh Backups
                </MudButton>
            </MudItem>
        </MudGrid>
        
@*         <MudAlert Severity="Severity.Info" Class="mt-4" Variant="Variant.Outlined">
            <MudAlertTitle>Information</MudAlertTitle>
            Backups are stored in: <MudText Typo="Typo.caption">@backupPath</MudText>
        </MudAlert> *@
    </MudCardContent>
</MudCard>

<MudPaper Class="mt-4 pa-4">
    <MudText Typo="Typo.h6" Class="mb-4">Available Backups</MudText>
    
    @if (backups.Count == 0)
    {
        <MudAlert Severity="Severity.Warning" Class="mt-4">
            No backups found. Create your first backup using the form above.
        </MudAlert>
    }
    else
    {
        <MudTable Items="@backups" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Backup Name</MudTh>
                <MudTh>Size</MudTh>
                <MudTh>Created</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.FormattedSize</MudTd>
                <MudTd>@context.FormattedDate</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Restore" Color="Color.Warning"
                                   Disabled="@(!_canRestore)"
                                  OnClick="() => OnRestore(context.Name)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                   Disabled="@(!_canDelete)"
                                  OnClick="() => OnDelete(context.Name)" Class="ml-2" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>




@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }
    public string? Title { get; private set; }
    // private BackupRestoreAccessRights _accessRights = new();

    private List<BackupFileDto> backups = new();
    private string? backupName = null;
    private string? selectedBackup = null;

    private bool _loading;
    private bool _uploading;

    [Inject]
    private IBlazorDownloadFileService BlazorDownloadFileService { get; set; } = null!;

    private bool _canCreate;
    private bool _canRestore;
    private bool _canDelete;


    protected override async Task OnInitializedAsync()
    {
        // Title = L[_currentDto.GetClassDescription()];
        var state = await AuthState;
        _canCreate = (await AuthService.AuthorizeAsync(state.User, Permissions.BackupRestore.Create)).Succeeded;
        _canRestore = (await AuthService.AuthorizeAsync(state.User, Permissions.BackupRestore.Restore)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Permissions.BackupRestore.Delete)).Succeeded;

        await LoadBackups();
    }
    // protected override async Task OnInitializedAsync()
    // {
    //     _accessRights = await PermissionService.GetAccessRightsAsync<BackupRestoreAccessRights>();
    //     await LoadBackups();
    // }


    private async Task LoadBackups()
    {
        try
        {
            backups = await Mediator.Send(new GetBackupsQuery());
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading backups: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnCreateBackup()
    {

        try
        {
            _uploading = true;

            var result = await Mediator.Send(new CreateBackupCommand(backupName));

            if (result)
            {
                Snackbar.Add("Backup file created Successfully", MudBlazor.Severity.Info);
                await LoadBackups();
                backupName = "";
            }
            else
            {
                Snackbar.Add($"Backup failed", Severity.Error);
            }

            }
            catch (Exception ex)
            {
                Snackbar.Add($"Backup failed: {ex.Message}", Severity.Error);
            }
            finally
            {
                _uploading = false;
            }   
        
    }



    private async Task OnRestore(string backupName)
    {
        var contentText = string.Format(ConstantString.ExecuteConfirmation, "Restore", backupName);
        var command = new RestoreBackupCommand(backupName);
        await DialogServiceHelper.ShowExecuteConfirmationDialogAsync(command, ConstantString.ExecuteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadBackups();
            });
        });
    }



    private async Task OnDelete(string backupName)
    {
        var contentText = string.Format(ConstantString.DeleteConfirmation, backupName);
        var command = new DeleteBackupCommand(backupName);
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                await LoadBackups();
            });
        });
    }


}
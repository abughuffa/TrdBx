@page "/pages/TrdBx/Invoices{InvoiceId:int}/details"
@using CleanArchitecture.Blazor.Application.Features.Invoices.Queries.GetById
@using CleanArchitecture.Blazor.Application.Features.Invoices.Commands.Delete
@using CleanArchitecture.Blazor.Application.Features.Invoices.DTOs
@using CleanArchitecture.Blazor.Application.TrdBx.Features.Invoices.DTOs

@inject IStringLocalizer<Invoices> L
@attribute [Authorize(Policy = Infrastructure.PermissionSet.Permissions.Invoices.View)]

<MudContainer>
    <MudCard Class="mt-4">
        <MudCardHeader>
            <MudAvatar>
                <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" />
            </MudAvatar>
            <MudCardHeader>
                <MudText Typo="Typo.h5">@L["Invoice Details"]</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @L["Invoice # "] @model?.InvoiceNo
                </MudText>
            </MudCardHeader>
            <MudCardActions>
                <MudButtonGroup Variant="Variant.Outlined">
                    <MudButton OnClick="GoBack" StartIcon="@Icons.Material.Filled.ArrowBack">
                        Back
                    </MudButton>
                    @if (_canDelete)
                    {
                        <MudButton Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="DeleteInvoice">
                            @ConstantString.Delete
                        </MudButton>
                    }

                </MudButtonGroup>
            </MudCardActions>
        </MudCardHeader>
        
        <MudCardContent>
            @if (_isLoading)
            {
                <MudProgressLinear Indeterminate="true" Class="my-6" />
                <MudText Align="Align.Center">@L["Loading invoice details..."]</MudText>
            }
            else if (model == null)
            {
                <MudAlert Severity="Severity.Warning" Class="my-6">
                    @L["Invoice not found. Please check the invoice ID."]
                </MudAlert>
            }
            else
            {
                <!-- Invoice Header Information -->
                <MudGrid Class="mb-6">
                    <MudItem xs="12" sm="6" md="4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["InvoiceNo"]</MudText>
                        <MudText Typo="Typo.body1">@model.InvoiceNo</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["InvoiceDate"]</MudText>
                        <MudText Typo="Typo.body1">@model.InvoiceDate.ToString("dd-MM-yyyy")</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["IStatus"]</MudText>
@*                         <MudChip Color="@GetStatusColor(_invoice.IStatus)" 
                                Label="@_invoice.IStatus" 
                                Variant="Variant.Filled" 
                                Size="Size.Small" /> *@
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["Customer"]</MudText>
                        <MudText Typo="Typo.body1">@model.Customer</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@L["GrandTotal"]</MudText>
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            @model.GrandTotal.ToString("N3")
                        </MudText>
                    </MudItem>
                </MudGrid>

                <!-- Item Groups DataGrid -->
                <MudText Typo="Typo.h6" Class="mb-3">@L["Invoice Items"]</MudText>
                
                <MudExpansionPanels MultiExpansion="true" Class="mb-4">
                    @foreach (var itemGroup in model.InvoiceItemGroups.OrderBy(ig => ig.SerialIndex))
                    {
                        <MudExpansionPanel>
                          <TitleContent>
                                <MudGrid>
                                    <MudItem xs="12" sm="6">
                                        <MudText Typo="Typo.subtitle1">
                                            @L["Items Group # "]@itemGroup.SerialIndex
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @itemGroup.Description
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" sm="6" Class="text-right">
                                        <MudText Typo="Typo.h6" Color="Color.Primary">
                                            @L["Subtotal : "] @itemGroup.SubTotal.ToString("N3")
                                        </MudText>
                                    </MudItem>
                                </MudGrid>

                          </TitleContent>

                       
                            <ChildContent>
                                <!-- Items DataGrid for this Item Group -->
                                <MudDataGrid Items="@itemGroup.InvoiceItems.OrderBy(i => i.SubSerialIndex)"
                                            T="InvoiceItemDto"
                                            Dense="true"
                                            Hover="true"
                                            Striped="true"
                                            ReadOnly="true"
                                            Class="mt-2">
                                    
                                    <ToolBarContent>
                                        <MudText Typo="Typo.subtitle2"> @L["Items"]</MudText>
                                        <MudSpacer />
                                        <MudText Typo="Typo.body2">
                                          @*   @L["Group's Items"] *@
                                            @itemGroup.InvoiceItems.Count items
                                        </MudText>
                                    </ToolBarContent>
                                    
                                    <Columns>
                                        <PropertyColumn Property="x => x.SubSerialIndex" 
                                                       Title="#" 
                                                       Sortable="true" />
                                        
                                        <PropertyColumn Property="x => x.Description" 
                                                       Title=@L["Description"] 
                                                       Sortable="true" />
                                        
                                        
               
                                        
                                        <PropertyColumn Property="x => x.Amount" 
                                                        Title=@L["Amount"]
                                                       Sortable="true"
                                                        Format="N3" />
                                        
                                        <TemplateColumn Title="Actions">
                                            <CellTemplate>
                                                @if (_canDeleteItem)
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                   Size="Size.Small"
                                                                   Color="Color.Error"
                                                                   OnClick="@(() => DeleteItem(context.Item))" />
                                                }

                                            </CellTemplate>
                                        </TemplateColumn>
                                    </Columns>
                                    
                                    <PagerContent>
                                        <MudTablePager />
                                    </PagerContent>
                                </MudDataGrid>
                                
                                <!-- Group Actions -->
                                <MudDivider Class="my-3" />
                                @if (_canDeleteGroup)
                                {
                                    <div class="d-flex justify-end mt-2">
                                        <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                            <MudButton StartIcon="@Icons.Material.Filled.Delete"
                                                       Color="Color.Error"
                                                       OnClick="@(() => DeleteItemGroup(itemGroup))">
                                                @ConstantString.Delete
                                            </MudButton>
                                        </MudButtonGroup>
                                    </div>
                                }

                            </ChildContent>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
                
                <!-- Summary Section -->
                <MudDivider Class="my-4" />
                <MudGrid>
                    <MudItem xs="12" md="8"></MudItem>
                    <MudItem xs="12" md="4">
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
                                <MudText Typo="Typo.body2">@L["Total:"]</MudText>
                                <MudText Typo="Typo.body1">
                                    @model.Total.ToString("N3")
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
                                <MudText Typo="Typo.body2">@L["Discount:"]</MudText>
                                <MudText Typo="Typo.body1">
                                    @model.DiscountAmount.ToString("N3")
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
                                <MudText Typo="Typo.body2">@L["Taxable:"]</MudText>
                                <MudText Typo="Typo.body1">
                                    @model.TaxableAmount.ToString("N3")
                                </MudText>
                            </MudStack>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
                                <MudText Typo="Typo.body2">@L["Tax:"]</MudText>
                                <MudText Typo="Typo.body1">@model.TaxAmount.ToString("N3")</MudText>
                            </MudStack>
                            <MudDivider Class="my-2" />
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.h6">@L["GrandTotal:"]</MudText>
                                <MudText Typo="Typo.h5" Color="Color.Primary">
                                    @model.GrandTotal.ToString("N3")
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [CascadingParameter] public Task<AuthenticationState> AuthState { get; set; } = default!;
    [Parameter] public int InvoiceId { get; set; }

    private InvoiceDto model;
    private bool _isLoading = true;
    // private decimal _taxAmount = 0; // You can calculate this based on your business logic

    private bool _canDelete;
    private bool _canDeleteGroup;
    private bool _canDeleteItem;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthState;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Invoices.Delete)).Succeeded;
        _canDeleteGroup = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Invoices.DeleteGroup)).Succeeded;
        _canDeleteItem = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Invoices.DeleteItem)).Succeeded;

        await LoadInvoice();

        var dd = model;
       var  cc = dd;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadInvoice();

        var dd = model;
        var cc = dd;
    }

//     private async Task<InvoiceDto> LoadInvoice()
//     {
//         // Title = L["SimCard"];
//         var result = await Mediator.Send(new GetDetailedInvoiceByIdQuery() { Id = InvoiceId });
//         result.Map(data =>
// {
//     // _invoice = data;
//     return data;
// }).Match(data =>
// {
//     return data;

// }, errors =>
// {
//     Snackbar.Add($"Error loading invoice: {errors}", Severity.Error);
//     return null!;
// });
//     }


    private async Task LoadInvoice()
    {
        // Title = L["SimCard"];

        _isLoading = true;

        var result = await Mediator.Send(new GetDetailedInvoiceByIdQuery() { Id = InvoiceId });
        model = result.Map(data =>
                            {
                                // model = data;
                                return data;
                            }).Match(data =>
                            {
                                return data;

                            }, errors =>
                            {
                                Snackbar.Add(errors, MudBlazor.Severity.Error);
                                return null!;
                            });
        _isLoading = false;
    }
    
    private Color GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "draft" => Color.Default,
            "sent" => Color.Info,
            "paid" => Color.Success,
            "cancelled" => Color.Error,
            _ => Color.Default
        };
    }
    


    private Task GoBack()
    {
        Navigation.NavigateTo($"/pages/TrdBx/Invoices");
        return Task.CompletedTask;
    }
    
    private async Task PrintInvoice()
    {
        // Implement print functionality
        Snackbar.Add("Print functionality would open print dialog", Severity.Info);
        
        // You could also open a print-optimized view
        // NavigationManager.NavigateTo($"/invoices/print/{InvoiceId}");
    }
    

    
    private async Task DeleteInvoice()
    {

        var contentText = string.Format(ConstantString.DeleteConfirmation, model.InvoiceNo);
        var command = new DeleteInvoiceCommand(model.Id);
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                Snackbar.Add("Invoice deleted successfully", Severity.Success);
                await GoBack();
            });
        });

    }
    

    private async Task DeleteItem(InvoiceItemDto dto)
    {

        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.SubSerialIndex);
        var command = new DeleteInvoiceItemCommand(dto.Id);
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                            Snackbar.Add("Item deleted successfully", Severity.Success);
                            await LoadInvoice(); // Refresh data
            });
        });

    }
    

    
    private async Task DeleteItemGroup(InvoiceItemGroupDto dto)
    {

        var contentText = string.Format(ConstantString.DeleteConfirmation, dto.SerialIndex);
        var command = new DeleteInvoiceItemGroupCommand(dto.Id);
        await DialogServiceHelper.ShowDeleteConfirmationDialogAsync(command, ConstantString.DeleteConfirmationTitle, contentText, async () =>
        {
            await InvokeAsync(async () =>
            {
                            Snackbar.Add("Item group deleted successfully", Severity.Success);
                            await LoadInvoice(); // Refresh data
            });
        });


    }
    

    }
    




@using CleanArchitecture.Blazor.Server.UI.Pages.TrdBx.Customers
@using CleanArchitecture.Blazor.Application.Features.Invoices.Queries.Pagination
@using CleanArchitecture.Blazor.Domain.Enums
@using CleanArchitecture.Blazor.Server.UI.Pages.TrdBx.Customers.Components


@inject IStringLocalizer<Invoices> L

<MudExpansionPanel @bind-Expanded="_advancedSearchExpanded"
                   Style="border-radius: var(--mud-default-borderradius) !important;"
                   Class="mud-elevation-25 pa-2 mb-3" Text="@ConstantString.AdvancedSearch">
    <MudGrid Spacing="2">

        <MudItem md="8">
            <AvaliableCustomers @bind-Value="@TRequest.CustomerId"
                                PHolder="@L["Filter by Customer"]"
                                WithAdvParents="true"
                                Clearable="true"
                                OnCustomerChanged="FilterChanged">
            </AvaliableCustomers>
        </MudItem>

        <MudItem md="2">
            <MudEnumSelect Style="min-width:120px"
                           Placeholder="@L["Filter By Type"]"
                           TEnum="InvoiceType?"
                           Value="@TRequest.InvoiceType"
                           ValueChanged="OnInvoiceTypeChanged"
                           Dense="true">
            </MudEnumSelect>
        </MudItem>
        <MudItem md="2">
                <MudEnumSelect Style="min-width:120px"
                           Placeholder="@L["Filter By Status"]"
                           TEnum="IStatus?"
                           Value="@TRequest.IStatus"
                           ValueChanged="OnIStatusChanged"
                           Dense="true" >
                </MudEnumSelect>
        </MudItem>
    </MudGrid>
</MudExpansionPanel>

@code {

    [EditorRequired][Parameter] public InvoicesWithPaginationQuery TRequest { get; set; } = null!;
    [EditorRequired][Parameter] public EventCallback<string> OnFilterCriteriaChanged { get; set; }

    private bool _advancedSearchExpanded;

    private async Task FilterChanged(string str)
    {
        if (_advancedSearchExpanded)
        {
            await OnFilterCriteriaChanged.InvokeAsync(str);
        }
    }


    private async Task OnIStatusChanged(IStatus? IStatus)
    {
        TRequest.IStatus = IStatus;
        await FilterChanged(IStatus?.ToString());
    }

    private async Task OnInvoiceTypeChanged(InvoiceType? InvoiceType)
    {
        TRequest.InvoiceType = InvoiceType;
        await FilterChanged(InvoiceType?.ToString());
    }
}
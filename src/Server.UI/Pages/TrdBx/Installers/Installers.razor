@using System.Linq.Expressions
@using CleanArchitecture.Blazor.Application.Common.Interfaces.Identity
@using CleanArchitecture.Blazor.Application.Features.Identity.DTOs
@using CleanArchitecture.Blazor.Application.Features.Installers.Queries.GetAvaliable
@using CleanArchitecture.Blazor.Domain.Identity
@using CleanArchitecture.Blazor.Infrastructure.Persistence

@inherits OwningComponentBase
@inject IStringLocalizer<Installers> L
@implements IDisposable


        <MudSelect T="string"
                   Disabled="!CanAssignOtherUser"
                   Label="@L["Installer"]"
                   Required="true"
                   RequiredError="@L["InstallerIsRequired"]"
                   Value="InstallerId"
                   ValueChanged="InstallerIdChanged">
            @foreach (var doc1type in installers)
            {
        <MudSelectItem T="string" Value="doc1type.Id">@doc1type.DisplayName</MudSelectItem>
            }
        </MudSelect>


@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }
    [Parameter] public string InstallerId { get; set; }
    [Parameter] public EventCallback<string> InstallerIdChanged { get; set; }

    private UserManager<ApplicationUser> _userManager = null!;
    private bool CanAssignOtherUser = false;
    private IEnumerable<ApplicationUserDto> installers = default!;

    protected override async Task OnInitializedAsync()
    {
        installers = await LoadInstallers();
        InstallerId = UserProfile.UserId;
        CanAssignOtherUser = UserProfile.AssignedRoles.Contains("Admin");
    }

    private async Task<IEnumerable<ApplicationUserDto>> LoadInstallers()
    {
        var data =  await Mediator.Send(new GetAvaliableInstallersQuery());
        return data;
    }
}

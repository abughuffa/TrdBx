@page "/pages/TrdBx/Subscriptions/{trackingunitid:int}/{servicelogid:int}"
@using CleanArchitecture.Blazor.Application.Features.Subscriptions.Caching
@using CleanArchitecture.Blazor.Application.Features.Subscriptions.DTOs
@using CleanArchitecture.Blazor.Application.Features.Subscriptions.Queries.Pagination




@inject IStringLocalizer<Subscriptions> L
@attribute [Authorize(Policy = Infrastructure.PermissionSet.Permissions.Subscriptions.View)]
@inject NavigationManager Navigation

<MudContainer Class="mt-3">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">@Title</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid ServerData="@(ServerReload)"
                         T="SubscriptionDto"
                         FixedHeader="true"
                         FixedFooter="true"
                         Loading="@_loading"
                         MultiSelection="false"
                         SelectOnRowClick="false"
                         ColumnResizeMode="ResizeMode.Column"
                         Hover="true" @ref="_table">

                <ToolBarContent>
                    <MudStack Row Spacing="0" Class="flex-grow-1" Justify="Justify.SpaceBetween">

                        <MudStack Row AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Window" Size="Size.Large" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">@Title</MudText>
                            </MudStack>
                        </MudStack>

                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudToolBar Dense WrapContent="true" Class="py-1 px-0">

                                <MudButton Disabled="@_loading"
                                           OnClick="@(() => OnRefresh())"
                                           StartIcon="@Icons.Material.Outlined.Refresh">
                                    @ConstantString.Refresh
                                </MudButton>





                            </MudToolBar>


                        </MudStack>

                    </MudStack>


                </ToolBarContent>

                <Columns>

                    <PropertyColumn Property="x => x.CaseCode" Title="@L[_currentDto.GetMemberDescription(x=>x.CaseCode)]" />
                    <PropertyColumn Property="x => x.Desc" Title="@L[_currentDto.GetMemberDescription(x=>x.Desc)]" />
                    <PropertyColumn Property="x => x.SsDate" Title="@L[_currentDto.GetMemberDescription(x=>x.SsDate)]" />
                    <PropertyColumn Property="x => x.SeDate" Title="@L[_currentDto.GetMemberDescription(x=>x.SeDate)]" />
                    <PropertyColumn Property="x => x.DailyFees" Title="@L[_currentDto.GetMemberDescription(x=>x.DailyFees)]" />
                    <PropertyColumn Property="x => x.Days" Title="@L[_currentDto.GetMemberDescription(x=>x.Days)]" />
                    <PropertyColumn Property="x => x.Amount" Title="@L[_currentDto.GetMemberDescription(x=>x.Amount)]" />
                </Columns>
                <NoRecordsContent>
                    <MudText>@ConstantString.NoRecords</MudText>
                </NoRecordsContent>
                <LoadingContent>
                    <MudText>@ConstantString.Loading</MudText>
                </LoadingContent>
                <PagerContent>
                    <MudDataGridPager PageSizeOptions="@(new int[] { 10, 15, 30, 50, 100 })" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton OnClick="OnGoBack">@ConstantString.GoBack</MudButton>
        </MudCardActions>
    </MudCard>
</MudContainer>


@code {

    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }
    [Parameter] public int TrackingUnitId { get; set; }
    [Parameter] public int ServiceLogId { get; set; }
    public string? Title { get; private set; }
    private HashSet<SubscriptionDto> _selectedItems = new();
    private MudDataGrid<SubscriptionDto> _table = default!;
    private SubscriptionDto _currentDto = new();
    // private SubscriptionsAccessRights _accessRights = new();
    private int _defaultPageSize = 10;
    private bool _loading;


    private SubscriptionsWithPaginationQuery Query { get; set; } = new();

    [Parameter]
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }


    [Inject]
    private IBlazorDownloadFileService BlazorDownloadFileService { get; set; } = null!;
    // private bool _canSearch;
    // private bool _canCreate;
    // private bool _canEdit;
    // private bool _canDelete;
    // private bool _canImport;
    // private bool _canExport;

    protected override async Task OnInitializedAsync()
    {
        Title = L[_currentDto.GetClassDescription()];
        // var state = await AuthState;
        // _canCreate = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Subscriptions.Create)).Succeeded;
        // _canSearch = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Subscriptions.Search)).Succeeded;
        // _canEdit = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Subscriptions.Edit)).Succeeded;
        // _canDelete = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Subscriptions.Delete)).Succeeded;
        // _canImport = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Subscriptions.Import)).Succeeded;
        // _canExport = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.Subscriptions.Export)).Succeeded;
    }
    // protected override async Task OnInitializedAsync()
    // {

    //     Title = L[_currentDto.GetClassDescription()];
    //     _accessRights = await PermissionService.GetAccessRightsAsync<SubscriptionsAccessRights>();
    // }


    private async Task<GridData<SubscriptionDto>> ServerReload(GridState<SubscriptionDto> state)
    {

        try
        {
            _loading = true;
            Query.TrackingUnitId = TrackingUnitId;
            Query.ServiceLogId = ServiceLogId;
            Query.OrderBy = state.SortDefinitions.FirstOrDefault()?.SortBy ?? "Id";
            Query.SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending ?? true
                                              ? SortDirection.Descending.ToString()
                                              : SortDirection.Ascending.ToString();
            Query.PageNumber = state.Page + 1;
            Query.PageSize = state.PageSize;
            var result = await Mediator.Send(Query).ConfigureAwait(false);
            return new GridData<SubscriptionDto> { TotalItems = result.TotalItems, Items = result.Items };
        }
        finally
        {
            _loading = false;
        }

    }

    private async Task OnRefresh()
    {
        SubscriptionCacheKey.Refresh();
        _selectedItems = new HashSet<SubscriptionDto>();
        Query.TrackingUnitId = TrackingUnitId;
        Query.ServiceLogId = ServiceLogId;
        await _table.ReloadServerData();
    }

    void OnGoBack()
    {
        var target = !string.IsNullOrWhiteSpace(ReturnUrl)
            ? ReturnUrl
            : Navigation.ToBaseRelativePath(Navigation.Uri);

        Navigation.NavigateTo(target);

    }

}

@page "/pages/TrdBx/TrackingUnits/Transfer/{trackingunitid:int}"


@using CleanArchitecture.Blazor.Application.Features.TrackedAssets.DTOs
@using CleanArchitecture.Blazor.Application.Features.TrackedAssets.Queries.GetAvaliable
@using CleanArchitecture.Blazor.Application.Features.Customers.DTOs
@using CleanArchitecture.Blazor.Application.Features.Customers.Queries.GetAvaliable
@using CleanArchitecture.Blazor.Application.Features.TrackingUnits.Mappers
@using CleanArchitecture.Blazor.Application.Features.TrackingUnits.Commands.DailyTasks.Transfer
@using CleanArchitecture.Blazor.Application.Features.TrackingUnits.Queries.GetById
@using CleanArchitecture.Blazor.Application.Features.SimCards.DTOs
@using CleanArchitecture.Blazor.Application.Features.SimCards.Queries.GetAvaliableSimCards
@using CleanArchitecture.Blazor.Domain.Enums
@* @using CleanArchitecture.Blazor.Server.UI.Pages.TrdBx.Installers *@

@inherits MudComponentBase
@inject IValidationService Validator
@inject IStringLocalizer<TrackingUnits> L
@attribute [Authorize(Policy = Permissions.TrackingUnits.Transfer)]

<PageTitle>@Title</PageTitle>

<MudContainer Class="mt-3" MaxWidth="MaxWidth.Small">
    @if (model != null)
    {
        <MudCard Class="pa-2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Title</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>

                <MudForm Model="@model" @ref="@_form" Validation="@(Validator.ValidateValue(model))">
                    <MudGrid Spacing="2">
                        <MudItem xs="12">
                            <MudText>model.SNo</MudText>
                        </MudItem>

                        <MudItem md="6">
                            <MudSelect For="@(() => model.SimCardId)"
                            Label="@L["SimCard"]"
                            Required="true"
                            RequiredError="@L["SimCard Is Required!"]"
                            @bind-Value="model.SimCardId">
                                <MudSelectItem T="int" Value=0>@L["Select SimCard"]</MudSelectItem>
                                @foreach (var doc1type in SimCards)
                                {
                                    <MudSelectItem Value="@doc1type.Id">@doc1type.SimCardNo</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem md="6">
                            <MudSelect For="@(() => model.TrackedAssetId)"
                            Label="@L["TrackedAsset"]"
                            Required="true"
                            RequiredError="@L["TrackedAsset Is Required!"]"
                            @bind-Value="model.TrackedAssetId">
                                <MudSelectItem T="int" Value=0>@L["Select TrackedAsset"]</MudSelectItem>
                                @foreach (var doc1type in TrackedAssets)
                                {
                                    <MudSelectItem Value="@doc1type.Id">@doc1type.TrackedAssetNo</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

                        <MudItem md="6">
                            <MudEnumSelect Style="min-width:120px" TEnum="InsMode" ValueChanged="OnChangedInsMode" Value="model.InsMode" Dense="true" Label="@L["InsMode"]">
                            </MudEnumSelect>
                        </MudItem>

                        <MudItem md="6">
                            <MudEnumSelect Style="min-width:120px" TEnum="SubPackage" ValueChanged="OnChangedSubPackage" Value="model.SubPackage" Dense="true" Label="@L["Subscription"]">
                            </MudEnumSelect>
                        </MudItem>


                        <MudItem md="12">
                            <MudSelect For="@(() => model.CustomerId)"
                            Label="@L["Customer"]"
                            Required="true"
                            RequiredError="@L["Customer Is Required!"]"
                            @bind-Value="model.CustomerId">
                                <MudSelectItem T="int" Value=0>@L["Select Customer"]</MudSelectItem>
                                @foreach (var doc1type in Customers)
                                {
                                    <MudSelectItem Value="@doc1type.Id">@doc1type.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>

@*                         <MudItem md="12">

                            <Installers @bind-InstallerId="model.InstallerId"></Installers>

                        </MudItem> *@

                        <MudItem md="6">
                            <MudCheckBox Label="@L["Create Deserved Services?"]"
                                         For="@(() => model.CreateDeservedServices)"
                                         @bind-Value="model.CreateDeservedServices">
                            </MudCheckBox>
                        </MudItem>


                        <MudItem md="6">
                            <MudDatePicker Class="pa-4"
                                           Label="@L["TaskDate"]"
                            Editable @bind-Date="_date"
                            For="@(() => _date)"
                            Required="true"
                                           RequiredError="@L["TaskDate Is Required!"]" />
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudCardContent>
            <MudCardActions Class="d-flex justify-end gap-2">
                <MudButton Color="Color.Primary" DropShadow="false" OnClick="Cancel">@ConstantString.Cancel</MudButton>
                <MudLoadingButton Color="Color.Primary" DropShadow="false" Loading="@_submiting" OnClick="Submit">@ConstantString.Submit</MudLoadingButton>
            </MudCardActions>
        </MudCard>
    }
</MudContainer>

    @code {

    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }

    private MudForm? _form;

    private TransferTrackingUnitCommand model = new();
    private TransferTrackingUnitCommand _model { get; set; }
    public string? Title { get; private set; }
    // public bool CanAssignOtherUser = false;
    private bool _submiting = false;

    [Parameter]
    public int TrackingUnitId { get; set; }

    private IEnumerable<SimCardDto> SimCards = new List<SimCardDto>();
    private IEnumerable<TrackedAssetDto> TrackedAssets = new List<TrackedAssetDto>();
    private IEnumerable<CustomerDto> Customers = new List<CustomerDto>();



    private async Task OnChangedInsMode(InsMode insMode)
    {
        model.InsMode = insMode;
        await Task.CompletedTask;
    }

    private async Task OnChangedSubPackage(SubPackage gpsSubscriptionStatus)
    {
        model.SubPackage = gpsSubscriptionStatus;
        await Task.CompletedTask;
    }


    private DateTime? _date
    {
        get => model.TsDate.ToDateTime(TimeOnly.MinValue);
        set
        {
            if (value is not null)
            {
                model.TsDate = DateOnly.FromDateTime((DateTime)value);
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (model != _model)
        {
            var result = await Mediator.Send(new GetTrackingUnitByIdQuery() { Id = TrackingUnitId });
            SimCards = await Mediator.Send(new GetAvaliableSimCardsQuery() { Ids = new int[] { (int)result.Data.SimCardId } });
            TrackedAssets = await Mediator.Send(new GetAvaliableTrackedAssetsQuery());
            Customers = await Mediator.Send(new GetAvaliableChildsByParentIdQuery() { Id = (int)result.Data.CustomerId });


            result.Map(data =>
             {
                 model = Mapper.ToTransferCommand(data);
                 return data;
             }).Match(data =>
             {
                 return data;

             }, errors =>
             {
                 Snackbar.Add(errors, MudBlazor.Severity.Error);
                 return null!;
             });
        }
        await base.OnParametersSetAsync();
        }
    protected override async Task OnInitializedAsync()
    {
        Title = L["Transfer TrackingUnit"];

        // CanAssignOtherUser = UserProfile.AssignedRoles.Contains("Admin");



    //     result.Map(data =>
    // {
    //     // model = Mapper.Map<TransferTrackingUnitCommand>(data);
    //     // model = Mapper.ToUpdateCommand(data);
    //     model = Mapper.ToTransferCommand(data);
    //     // model.InstallerId = UserProfile.UserId;
    //     return Task.CompletedTask;
    //     // return data;

    // }).Match(data =>
    //     {

    //     }, errors => { Snackbar.Add($"{errors}", Severity.Error); });



    }
    async Task Submit()
    {
        var succeed = false;
        try
        {
            _submiting = true;
            await _form!.Validate().ConfigureAwait(false);
            if (!_form!.IsValid)
                return;
            var result = await Mediator.Send(model);
            result.Match(
            data =>
            {
              Snackbar.Add(ConstantString.SaveSuccess, MudBlazor.Severity.Info);
                succeed = true;
              return data;
            },
            errors =>
            {
              Snackbar.Add(errors, MudBlazor.Severity.Error);
              return -1;
            });
//             result.Match(
// data =>
// {
//     Snackbar.Add(ConstantString.SaveSuccess, MudBlazor.Severity.Info);
            //     succeed = true;
// },
// errors =>
// {
//    Snackbar.Add(errors, MudBlazor.Severity.Error);
// });
        }
        finally
        {
            _submiting = false;
            if (succeed) Navigation.NavigateTo($"/pages/TrdBx/TrackingUnits");
        }
    }

    async Task Cancel()
    {
        Navigation.NavigateTo($"/pages/TrdBx/TrackingUnits");

    }

}
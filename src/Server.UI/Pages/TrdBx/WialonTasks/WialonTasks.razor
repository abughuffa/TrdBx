@page "/pages/TrdBx/WialonTasks/{trackingunitid:int}/{servicelogid:int}"

@using CleanArchitecture.Blazor.Application.Features.WialonTasks.Mappers
@using CleanArchitecture.Blazor.Application.Features.WialonTasks.Caching
@using CleanArchitecture.Blazor.Application.Features.WialonTasks.Commands.Execute
@using CleanArchitecture.Blazor.Application.Features.WialonTasks.DTOs
@using CleanArchitecture.Blazor.Application.Features.WialonTasks.Queries.Pagination
@using CleanArchitecture.Blazor.Server.UI.Pages.TrdBx.WialonTasks.Components

@inject IStringLocalizer<WialonTasks> L

@attribute [Authorize(Policy = Infrastructure.PermissionSet.Permissions.WialonTasks.View)]

<MudContainer Class="mt-3">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">@Title</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudDataGrid ServerData="@(ServerReload)"
                         T="WialonTaskDto"
                         FixedHeader="true"
                         FixedFooter="true"
                         Loading="@_loading"
                         MultiSelection="false"
                         SelectOnRowClick="false"
                         ColumnResizeMode="ResizeMode.Column"
                         Hover="true" @ref="_table">

                <ToolBarContent>
                    <MudStack Row Spacing="0" Class="flex-grow-1" Justify="Justify.SpaceBetween">

                        <MudStack Row AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Window" Size="Size.Large" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">@Title</MudText>
                            </MudStack>
                        </MudStack>

                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                            <MudToolBar Dense WrapContent="true" Class="py-1 px-0">

                                <MudButton Disabled="@_loading"
                                           OnClick="@(() => OnRefresh())"
                                           StartIcon="@Icons.Material.Outlined.Refresh">
                                    @ConstantString.Refresh
                                </MudButton>
                            </MudToolBar>
                        </MudStack>
                    </MudStack>
                </ToolBarContent>

                <Columns>

                    <TemplateColumn Title="Actions" HeaderStyle="width:80px" Sortable="false">
                        <CellTemplate>
                            <MudStack Spacing="2" Row="true" Justify="Justify.FlexStart">

                                <MudIconButton Icon="@Icons.Material.Filled.Web" Color="Color.Warning"
                                               Disabled="@(!(_canExecute && (!context.Item.IsExecuted)))"
                                               OnClick="() => OnExecute(context.Item)" />
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
@*                     <PropertyColumn Property="x => x.ServiceLogId" Title="@L[_currentDto.GetMemberDescription(x=>x.ServiceLogId)]" />
                    <PropertyColumn Property="x => x.TrackingUnitId" Title="@L[_currentDto.GetMemberDescription(x=>x.TrackingUnitId)]" /> *@
                    <PropertyColumn Property="x => x.ServiceLog" Title="@L[_currentDto.GetMemberDescription(x => x.ServiceLog)]" Groupable="true" />
                    <PropertyColumn Property="x => x.TrackingUnit" Title="@L[_currentDto.GetMemberDescription(x => x.TrackingUnit)]" />
                    <PropertyColumn Property="x => x.Desc" Title="@L[_currentDto.GetMemberDescription(x=>x.Desc)]" />
                    <PropertyColumn Property="x => x.ExcDate" Title="@L[_currentDto.GetMemberDescription(x=>x.ExcDate)]" />
                    <PropertyColumn Property="x => x.IsExecuted" Title="@L[_currentDto.GetMemberDescription(x=>x.IsExecuted)]" />


                </Columns>
                <NoRecordsContent>
                    <MudText>@ConstantString.NoRecords</MudText>
                </NoRecordsContent>
                <LoadingContent>
                    <MudText>@ConstantString.Loading</MudText>
                </LoadingContent>
                <PagerContent>
                    <MudDataGridPager PageSizeOptions="@(new int[] { 10, 15, 30, 50, 100 })" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton OnClick="OnGoBack">@ConstantString.GoBack</MudButton>
        </MudCardActions>
    </MudCard>
</MudContainer>


@code {

    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }
    [Parameter] public int TrackingUnitId { get; set; }
    [Parameter] public int ServiceLogId { get; set; }
    [Parameter][SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

    public string? Title { get; private set; }
    private HashSet<WialonTaskDto> _selectedItems = new();
    private MudDataGrid<WialonTaskDto> _table = default!;
    private WialonTaskDto _currentDto = new();
    // private WialonTasksAccessRights _accessRights = new();
    private int _defaultPageSize = 10;
    private bool _loading;

    private WialonTasksWithPaginationQuery Query { get; set; } = new();

    // private bool _canSearch;
    private bool _canExecute;
    private bool _canDelete;


    protected override async Task OnInitializedAsync()
    {
        Title = L[_currentDto.GetClassDescription()];
        var state = await AuthState;
        // _canSearch = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.WialonTasks.Search)).Succeeded;
        _canExecute = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.WialonTasks.Execute)).Succeeded;
        _canDelete = (await AuthService.AuthorizeAsync(state.User, Infrastructure.PermissionSet.Permissions.WialonTasks.Delete)).Succeeded;
    }


    // protected override async Task OnInitializedAsync()
    // {

    //     Title = L[_currentDto.GetClassDescription()];
    //     _accessRights = await permissionService.GetAccessRightsAsync<WialonTasksAccessRights>();
    // }

    private async Task<GridData<WialonTaskDto>> ServerReload(GridState<WialonTaskDto> state)
    {

        try
        {
            _loading = true;
            Query.TrackingUnitId = TrackingUnitId;
            Query.ServiceLogId = ServiceLogId;
            Query.OrderBy = state.SortDefinitions.FirstOrDefault()?.SortBy ?? "Id";
            Query.SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending ?? true
                                              ? SortDirection.Descending.ToString()
                                              : SortDirection.Ascending.ToString();
            Query.PageNumber = state.Page + 1;
            Query.PageSize = state.PageSize;
            var result = await Mediator.Send(Query).ConfigureAwait(false);
            return new GridData<WialonTaskDto> { TotalItems = result.TotalItems, Items = result.Items };
        }
        finally
        {
            _loading = false;
        }

    }

    private async Task OnRefresh()
    {
        WialonTaskCacheKey.Refresh();
        _selectedItems = new HashSet<WialonTaskDto>();
        Query.TrackingUnitId = TrackingUnitId;
        Query.ServiceLogId = ServiceLogId;
        await _table.ReloadServerData();
    }


    private Task OnExecute(WialonTaskDto dto)
    {
        // var command = Mapper.Map<ActivateTrackingUnitCommand>(dto);
        var command = Mapper.ToExecuteCommand(dto);
        // command.InstallerId = UserProfile.UserId;
        return DialogServiceHelper.ShowFormDialogWithContentTextAsync<WialonTaskExecuteDialog, ExecuteWialonTaskCommand>(
            L["Execute Wialon Task"],
            L["Select Execution date to Execute Wialon Task and mark it as executed."],
            command,
            async () =>
            {
                await _table.ReloadServerData();
                _selectedItems.Clear();
            });
    }

    void OnGoBack()
    {
        var target = !string.IsNullOrWhiteSpace(ReturnUrl)
            ? ReturnUrl
            : Navigation.ToBaseRelativePath(Navigation.Uri);

        Navigation.NavigateTo(target);

    }

}

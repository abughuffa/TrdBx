@using CleanArchitecture.Blazor.Server.UI.Pages.TrdBx.Customers
@using CleanArchitecture.Blazor.Application.Features.Customers.DTOs
@using CleanArchitecture.Blazor.Application.Features.Customers.Queries.GetAvaliable

@inherits MudComponentBase
@inject IStringLocalizer<Customers> L
@attribute [Authorize(Policy = Infrastructure.PermissionSet.Permissions.Customers.View)]


<MudGrid>
    <MudItem md="8">
        <MudSelect T="int?"
                   Placeholder="@PHolder"
                   Disabled="@Disabled"
                   Clearable="@Clearable"
                   Value="@Value"
                   ValueChanged="OnValueChanged">
            @foreach (var customer in customers)
            {
                <MudSelectItem Value="(int?)customer.Id">@customer.ParentChild</MudSelectItem>
            }
        </MudSelect>
    </MudItem>
</MudGrid>


@code {
    [Parameter] public int? Value { get; set; }
    [Parameter] public EventCallback<int?> ValueChanged { get; set; }
    [Parameter] public string PHolder { get; set; } = string.Empty;
    [Parameter] public bool Clearable { get; set; } = false;
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool WithAdvParents { get; set; }


    [EditorRequired][Parameter] public EventCallback<string> OnCustomerChanged { get; set; }



    private IEnumerable<CustomerDto> customers =  new List<CustomerDto>();

    private GetAvaliableCustomersQuery GetAvaliableCustomersQuery = new();

    private void OnValueChanged(int? id)
    {
        Value = id;
        ValueChanged.InvokeAsync(id);
        OnCustomerChanged.InvokeAsync();
    }




    protected override async Task OnInitializedAsync()
    {
        GetAvaliableCustomersQuery = new GetAvaliableCustomersQuery() { WithAdvParents = WithAdvParents };
        customers = await LoadAvaliableCustomers();
        StateHasChanged();

    }

    private async Task<IEnumerable<CustomerDto>> LoadAvaliableCustomers()
    {
        var result = await Mediator.Send(GetAvaliableCustomersQuery);
        return result;
    }

}
